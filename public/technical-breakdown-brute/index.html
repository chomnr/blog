<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- GENERAL -->
  <title>Zeljko Vranjes - Blog</title>
  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
    rel="stylesheet" />
  <!-- STYLESHEETS -->
  
  <link rel="stylesheet" href="https://blog.zeljkovranjes.com/main.css" />
  
  <link rel="stylesheet" href="https://blog.zeljkovranjes.com/modern-normalize.css" />
  
  <!--
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'" />
--></head>

  <body>
    <main>
<div class="content">
  <div class="col" style="gap: 7px">
    <div
      class="column"
      style="font-size: 0.85rem; justify-content: center; gap: 25px">
      <a href="/" style="text-decoration: none">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-arrow-90deg-left"
          viewBox="0 0 16 16">
          <path
            fill-rule="evenodd"
            d="M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708z" />
        </svg>
        BLOG
      </a>
      <div class="header">
        <div class="title">Technical Breakdown: Brute</div>
        <div class="date">September, 21, 2024</div>
      </div>
      <div class="links">
        <a
          href="https://github.com/chomnr/blog/tree/main/content/technical-breakdown-brute.md">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-code"
            viewBox="0 0 16 16">
            <path
              d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8z" />
          </svg>
        </a>
      </div>
    </div>
  </div>
</div>
<div class="post-content"><h1 id="introducing-brute-monitors-authentication-attempts-on-your-server">Introducing Brute: Monitors authentication attempts on your server</h1>
<p>I'm excited to announce the release of my latest project, <strong>Brute</strong>. This application represents a complete redevelopment of my previous attempt at a security monitoring tool, addressing numerous design flaws and performance issues.</p>
<p>For those unfamiliar with the project, I encourage you to check out the <a href="https://github.com/chomnr/brute">GitHub repository</a> for full details and implementation.</p>
<h2 id="the-predecessor-bruteexpose">The Predecessor: BruteExpose</h2>
<p>Now you might be wondering what was wrong with its predecessor BruteExpose, well, everything. Here's a list:</p>
<h3 id="key-issues">Key Issues</h3>
<ol>
<li>
<p><strong>Inefficient Geolocation Implementation</strong><br />
I relied on IPinfo's MMDB (MaxMind Database) instead of their API, which caused errors when processing IP addresses not found in the database. The database required manual updates, creating maintenance overhead and reliability issues.</p>
</li>
<li>
<p><strong>Poor Data Storage Strategy</strong><br />
Using JSON as a database proved to be a significant mistake. While writing operations functioned adequately, reading operations became problematic once the file reached a certain size. This limitation seriously impacted reliability, regardless of server specifications.</p>
</li>
<li>
<p><strong>Overly Complex Data Structure</strong><br />
The JSON file structure—managed through an ObjectMapper—was highly organized but unnecessarily complex. It tracked password usage, usernames, various metrics (hourly, daily, weekly), country data, and username/password combinations. This approach cluttered the codebase and created maintenance challenges.</p>
</li>
<li>
<p><strong>Inefficient Log Processing</strong><br />
BruteExpose relied on monitoring a text file for SSH login attempts. The application would:</p>
<ul>
<li>Wait for OpenSSH to dump credentials to a text file</li>
<li>Read the file contents</li>
<li>Parse individual log entries</li>
<li>Parse the entire log</li>
<li>Store results in the JSON file</li>
</ul>
<p>This approach was inefficient and required regular maintenance to prevent the log file from growing too large.</p>
</li>
</ol>
<p>The only positive aspect of BruteExpose was its WebSocket implementation, which allowed for real-time updates.</p>
<h2 id="the-successor-brute">The Successor: Brute</h2>
<p>For the redevelopment, I chose Rust instead of Java for its reliability, memory safety, and performance benefits. Here's how Brute improves upon its predecessor:</p>
<h3 id="major-improvements">Major Improvements</h3>
<ol>
<li>
<p><strong>Language Choice</strong><br />
Rust provides superior memory safety and reliability compared to Java, making it ideal for a security-focused application.</p>
</li>
<li>
<p><strong>Professional Database Implementation</strong><br />
I replaced the JSON-based storage with PostgreSQL, enabling better data management, improved query capabilities, and the ability to collect data from multiple "farmer" servers.</p>
</li>
<li>
<p><strong>Modern API Architecture</strong><br />
Instead of monitoring text files for changes, Brute implements an HTTP server with dedicated endpoints (/brute/attack/add) protected by bearer token authentication. This approach processes data immediately and broadcasts updates to WebSocket clients in real-time.</p>
</li>
<li>
<p><strong>Reliable Geolocation</strong><br />
Implementing the IPInfo API eliminated issues with missing IP addresses and removed the need for manual database updates.</p>
</li>
<li>
<p><strong>Actor-Based Architecture</strong><br />
Without the constraints of a JSON database, I adopted an actor-based design pattern, assigning specific handlers for each task to improve code organization and maintainability.</p>
</li>
</ol>
<h2 id="technical-implementation">Technical Implementation</h2>
<h3 id="core-dependencies">Core Dependencies</h3>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#65737e;"># Main crates
</span><span style="color:#bf616a;">actix </span><span>= &quot;</span><span style="color:#a3be8c;">0.13.5</span><span>&quot;
</span><span style="color:#bf616a;">actix-web </span><span>= { </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">4</span><span>&quot;, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">rustls-0_23</span><span>&quot;] }
</span><span style="color:#bf616a;">sqlx </span><span>= { </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.8.0</span><span>&quot;, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">runtime-tokio</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">tls-rustls</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">postgres</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">derive</span><span>&quot;] }
</span><span style="color:#bf616a;">actix-web-actors </span><span>= &quot;</span><span style="color:#a3be8c;">4.3.0</span><span>&quot;
</span><span style="color:#bf616a;">serde </span><span>= { </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">1.0.130</span><span>&quot;, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">derive</span><span>&quot;] }
</span><span style="color:#bf616a;">serde_json </span><span>= &quot;</span><span style="color:#a3be8c;">1.0.122</span><span>&quot;
</span><span style="color:#bf616a;">ipinfo </span><span>= &quot;</span><span style="color:#a3be8c;">3.0.0</span><span>&quot;
</span></code></pre>
<p>I initially used Axum as the web framework but switched to Actix-web due to specific issues. The transition didn't immediately resolve my problem, and the ultimate fix likely involved implementing the actor system to handle post-request mechanisms correctly.</p>
<h3 id="http-endpoint-implementation">HTTP Endpoint Implementation</h3>
<p>The <code>/brute/attack/add</code> endpoint processes incoming attack data:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">post</span><span>(&quot;</span><span style="color:#a3be8c;">/attack/add</span><span>&quot;)]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">post_brute_attack_add</span><span>(
</span><span>    </span><span style="color:#bf616a;">state</span><span>: web::Data&lt;AppState&gt;,
</span><span>    </span><span style="color:#bf616a;">payload</span><span>: web::Json&lt;AttackPayload&gt;,
</span><span>    </span><span style="color:#bf616a;">bearer</span><span>: BearerAuth,
</span><span>) -&gt; Result&lt;HttpResponse, BruteResponeError&gt; {
</span><span>    </span><span style="color:#65737e;">// Verify bearer token
</span><span>    </span><span style="color:#b48ead;">if </span><span>!bearer.</span><span style="color:#96b5b4;">token</span><span>().</span><span style="color:#96b5b4;">eq</span><span>(&amp;state.bearer) {
</span><span>        </span><span style="color:#b48ead;">return </span><span>Ok(HttpResponse::Unauthorized().</span><span style="color:#96b5b4;">body</span><span>(&quot;</span><span style="color:#a3be8c;">body</span><span>&quot;));
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#65737e;">// Reject local IP addresses
</span><span>    </span><span style="color:#b48ead;">if</span><span> payload.ip_address.</span><span style="color:#96b5b4;">eq</span><span>(&quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span>&quot;) {
</span><span>        </span><span style="color:#b48ead;">return </span><span>Err(BruteResponeError::ValidationError(&quot;</span><span style="color:#a3be8c;">empty ip or local ip</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()));
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#65737e;">// Create individual record
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> individual = Individual::new_short(
</span><span>        payload.username.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>        payload.password.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>        payload.ip_address.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>        payload.protocol.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>    );
</span><span>
</span><span>    </span><span style="color:#65737e;">// Validate data
</span><span>    individual.</span><span style="color:#96b5b4;">validate</span><span>()?;
</span><span>
</span><span>    </span><span style="color:#65737e;">// Process data and broadcast results
</span><span>    </span><span style="color:#b48ead;">match</span><span> state.actor.</span><span style="color:#96b5b4;">send</span><span>(individual).await {
</span><span>        Ok(res) =&gt; {
</span><span>            websocket::BruteServer::broadcast(websocket::ParseType::ProcessedIndividual, res.</span><span style="color:#96b5b4;">unwrap</span><span>());
</span><span>            Ok(HttpResponse::Ok().</span><span style="color:#96b5b4;">into</span><span>())
</span><span>        },
</span><span>        Err(er) =&gt; Err(BruteResponeError::InternalError(er.</span><span style="color:#96b5b4;">to_string</span><span>())),
</span><span>    }
</span><span>}
</span></code></pre>
<p>The endpoint follows a clear workflow:</p>
<ol>
<li>Verify authentication via bearer token</li>
<li>Validate IP address (no local addresses)</li>
<li>Perform comprehensive validation (string length, IP range verification)</li>
<li>Process data through the actor system</li>
<li>Broadcast results to WebSocket clients</li>
</ol>
<h3 id="actor-system">Actor System</h3>
<p>The <code>BruteSystem</code> actor handles various operations through dedicated handlers:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl </span><span>Handler&lt;Individual&gt; </span><span style="color:#b48ead;">for </span><span>BruteSystem {
</span><span>    </span><span style="color:#b48ead;">type </span><span>Result = ResponseActFuture&lt;</span><span style="color:#b48ead;">Self</span><span>, Result&lt;ProcessedIndividual, BruteResponeError&gt;&gt;;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">handle</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">msg</span><span>: Individual, _: &amp;</span><span style="color:#b48ead;">mut Self::</span><span>Context) -&gt; </span><span style="color:#b48ead;">Self::</span><span>Result {
</span><span>        </span><span style="color:#b48ead;">let</span><span> reporter = </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#96b5b4;">reporter</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> fut = async </span><span style="color:#b48ead;">move </span><span>{
</span><span>            </span><span style="color:#b48ead;">match</span><span> reporter.</span><span style="color:#96b5b4;">start_report</span><span>(msg).await {
</span><span>                Ok(result) =&gt; {
</span><span>                    info!(
</span><span>                        &quot;</span><span style="color:#a3be8c;">Successfully processed Individual with ID: {}. Details: Username: &#39;{}&#39;, IP: &#39;{}&#39;, Protocol: &#39;{}&#39;, Timestamp: {}, Location: {} - {}, {}, {}</span><span>&quot;,
</span><span>                        result.</span><span style="color:#96b5b4;">id</span><span>(),
</span><span>                        result.</span><span style="color:#96b5b4;">username</span><span>(),
</span><span>                        result.</span><span style="color:#96b5b4;">ip</span><span>(),
</span><span>                        result.</span><span style="color:#96b5b4;">protocol</span><span>(),
</span><span>                        result.</span><span style="color:#96b5b4;">timestamp</span><span>(),
</span><span>                        result.</span><span style="color:#96b5b4;">city</span><span>().</span><span style="color:#96b5b4;">as_ref</span><span>().</span><span style="color:#96b5b4;">unwrap_or</span><span>(&amp;&quot;</span><span style="color:#a3be8c;">{EMPTY}</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()),
</span><span>                        result.</span><span style="color:#96b5b4;">region</span><span>().</span><span style="color:#96b5b4;">as_ref</span><span>().</span><span style="color:#96b5b4;">unwrap_or</span><span>(&amp;&quot;</span><span style="color:#a3be8c;">{EMPTY}</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()),
</span><span>                        result.</span><span style="color:#96b5b4;">country</span><span>().</span><span style="color:#96b5b4;">as_ref</span><span>().</span><span style="color:#96b5b4;">unwrap_or</span><span>(&amp;&quot;</span><span style="color:#a3be8c;">{EMPTY}</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>()),
</span><span>                        result.</span><span style="color:#96b5b4;">postal</span><span>().</span><span style="color:#96b5b4;">as_ref</span><span>().</span><span style="color:#96b5b4;">unwrap_or</span><span>(&amp;&quot;</span><span style="color:#a3be8c;">{EMPTY}</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>())
</span><span>                    );
</span><span>                    Ok(result)
</span><span>                }
</span><span>                Err(e) =&gt; {
</span><span>                    error!(&quot;</span><span style="color:#a3be8c;">Failed to process report: {}</span><span>&quot;, e);
</span><span>                    Err(BruteResponeError::InternalError(
</span><span>                        &quot;</span><span style="color:#a3be8c;">something definitely broke on our side</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>                    ))
</span><span>                }
</span><span>            }
</span><span>        };
</span><span>        fut.</span><span style="color:#96b5b4;">into_actor</span><span>(</span><span style="color:#bf616a;">self</span><span>).</span><span style="color:#96b5b4;">map</span><span>(|</span><span style="color:#bf616a;">res</span><span>, _, _| res).</span><span style="color:#96b5b4;">boxed_local</span><span>()
</span><span>    }
</span><span>}
</span></code></pre>
<p>The <code>reporter.start_report()</code> method initiates a transaction for database operations, managing the process of storing and processing attack data.</p>
<h3 id="reporter-system">Reporter System</h3>
<p>The application uses a <code>Reportable</code> trait to standardize database interactions:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">allow</span><span>(async_fn_in_trait)]
</span><span style="color:#b48ead;">pub trait </span><span>Reportable&lt;T, R&gt; {
</span><span>      async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">report</span><span>&lt;</span><span style="color:#b48ead;">&#39;a</span><span>&gt;(</span><span style="color:#bf616a;">reporter</span><span>: &amp;T, </span><span style="color:#bf616a;">model</span><span>: &amp;</span><span style="color:#b48ead;">&#39;a</span><span> R) -&gt; anyhow::Result&lt;R&gt;
</span><span>      </span><span style="color:#b48ead;">where
</span><span>          </span><span style="color:#b48ead;">Self</span><span>: Sized;
</span><span>}
</span></code></pre>
<p>Implementation example for the <code>Individual</code> model:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">impl </span><span>Reportable&lt;BruteReporter, Individual&gt; </span><span style="color:#b48ead;">for </span><span>Individual {
</span><span>    async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">report</span><span>&lt;</span><span style="color:#b48ead;">&#39;a</span><span>&gt;(
</span><span>        </span><span style="color:#bf616a;">reporter</span><span>: &amp;BruteReporter,
</span><span>        </span><span style="color:#bf616a;">model</span><span>: &amp;</span><span style="color:#b48ead;">&#39;a</span><span> Individual,
</span><span>    ) -&gt; anyhow::Result&lt;Individual&gt; {
</span><span>        </span><span style="color:#b48ead;">let</span><span> pool = &amp;reporter.brute.db_pool;
</span><span>        </span><span style="color:#b48ead;">let</span><span> query = </span><span style="color:#b48ead;">r</span><span>#&quot;
</span><span style="color:#a3be8c;">            INSERT INTO individual (id, username, password, ip, protocol, timestamp)
</span><span style="color:#a3be8c;">            VALUES ($1, $2, $3, $4, $5, $6)
</span><span style="color:#a3be8c;">            RETURNING *
</span><span style="color:#a3be8c;">        </span><span>&quot;#;
</span><span>
</span><span>        </span><span style="color:#65737e;">// Generate new ID and timestamp for the new instance
</span><span>        </span><span style="color:#b48ead;">let</span><span> new_id = Uuid::new_v4().</span><span style="color:#96b5b4;">as_simple</span><span>().</span><span style="color:#96b5b4;">to_string</span><span>();
</span><span>        </span><span style="color:#b48ead;">let</span><span> new_timestamp = SystemTime::now()
</span><span>            .</span><span style="color:#96b5b4;">duration_since</span><span>(</span><span style="color:#d08770;">UNIX_EPOCH</span><span>)
</span><span>            .</span><span style="color:#96b5b4;">unwrap</span><span>()
</span><span>            .</span><span style="color:#96b5b4;">as_millis</span><span>() as </span><span style="color:#b48ead;">i64</span><span>;
</span><span>
</span><span>        </span><span style="color:#65737e;">// Execute the query and get the inserted data
</span><span>        </span><span style="color:#b48ead;">let</span><span> inserted = sqlx::query_as::&lt;_, Individual&gt;(query)
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(&amp;new_id)
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(&amp;model.</span><span style="color:#96b5b4;">username</span><span>())
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(&amp;model.</span><span style="color:#96b5b4;">password</span><span>())
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(&amp;model.</span><span style="color:#96b5b4;">ip</span><span>())
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(&amp;model.</span><span style="color:#96b5b4;">protocol</span><span>())
</span><span>            .</span><span style="color:#96b5b4;">bind</span><span>(new_timestamp)
</span><span>            .</span><span style="color:#96b5b4;">fetch_one</span><span>(pool)
</span><span>            .await?;
</span><span>
</span><span>        Ok(inserted)
</span><span>    }
</span><span>}
</span></code></pre>
<p>This creates a database entry with the specified values in a clean, maintainable pattern.</p>
<h3 id="optimized-ipinfo-integration">Optimized IPInfo Integration</h3>
<p>To minimize API usage, I implemented a caching system for IP data:</p>
<ol>
<li>Check if the IP exists in the cache</li>
<li>If found and entry is less than 5 minutes old, use cached data</li>
<li>If not found or data is stale, fetch from the API</li>
<li>Store results in cache</li>
</ol>
<p>This approach significantly reduces API requests while maintaining data accuracy.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The successor is 100000% better than the predecessor, as it should be; the project has been running inside of a docker container for about three days now and has had no errors! So, I can safely say this project was well thought out</p>
 </main>
  </body>
</html>

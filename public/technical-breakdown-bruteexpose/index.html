<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- GENERAL -->
  <title>Zeljko Vranjes - Blog</title>
  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
    rel="stylesheet" />
  <!-- STYLESHEETS -->
  
  <link rel="stylesheet" href="https://blog.zeljkovranjes.com/main.css" />
  
  <link rel="stylesheet" href="https://blog.zeljkovranjes.com/modern-normalize.css" />
  
  <!--
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'" />
--></head>

  <body>
    <main>
<div class="content">
  <div class="col" style="gap: 7px">
    <div
      class="column"
      style="font-size: 0.85rem; justify-content: center; gap: 25px">
      <a href="/" style="text-decoration: none">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-arrow-90deg-left"
          viewBox="0 0 16 16">
          <path
            fill-rule="evenodd"
            d="M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708z" />
        </svg>
        BLOG
      </a>
      <div class="header">
        <div class="title">Technical Breakdown: BruteExpose</div>
        <div class="date">April, 15, 2023</div>
      </div>
      <div class="links">
        <a
          href="https://github.com/chomnr/blog/tree/main/content/technical-breakdown-bruteexpose.md">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-code"
            viewBox="0 0 16 16">
            <path
              d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8z" />
          </svg>
        </a>
      </div>
    </div>
  </div>
</div>
<div class="post-content"><h1 id="live-security-monitor-formerly-bruteexpose">Live Security Monitor (Formerly BruteExpose)</h1>
<p><em>Project inspired by <a href="https://brute.fail/">Brute.Fail</a></em></p>
<h2 id="project-overview">Project Overview</h2>
<p><a href="https://github.com/chomnr/live-security-monitor">Live Security Monitor</a> tracks login attempts to OpenSSH servers, recording:</p>
<ul>
<li>Credentials used</li>
<li>Origin (IP address &amp; country)</li>
<li>Attack protocol</li>
<li>Timestamp of attempt</li>
</ul>
<p>This security monitoring tool provides valuable insights into potential brute force attacks on your server infrastructure (you really shouldn't because we have to patch OpenSSH to get to actually to work.).</p>
<h2 id="technology-choice">Technology Choice</h2>
<p>I developed this project in Java primarily to diversify my portfolio. In retrospect, C or C++ would have been more suitable languages for this application because they're low level languages. My familiarity with Java from previous Minecraft plugin development made it a comfortable choice, though not necessarily the optimal one.</p>
<h2 id="metrics-analytics-system">Metrics &amp; Analytics System</h2>
<h3 id="data-collection">Data Collection</h3>
<p>For collecting geographic metrics, I implemented IPInfo's MaxMind database (mmdb). While functional, this approach requires regular database updates to maintain accuracy. In retrospect, implementing the IPInfo API would have provided better maintainability and more current data.</p>
<h3 id="analytics-processing">Analytics Processing</h3>
<p>The application includes a modular analytics system that processes collected data into meaningful insights. The system is designed for extensibility, allowing easy addition or removal of different statistical metrics that are automatically reflected in the JSON output.</p>
<h4 id="currently-supported-analytics-as-of-june-1-2024">Currently Supported Analytics (as of June 1, 2024):</h4>
<ul>
<li>Number of attempts over time</li>
<li>Attack totals by day of week</li>
<li>Distribution of attack protocols</li>
<li>Attack origins by country</li>
<li>Attack origins by IP address</li>
<li>Commonly targeted credentials</li>
</ul>
<h3 id="implementation-example">Implementation Example</h3>
<p>Below is an example of how analytics are implemented in the system:</p>
<h4 id="protocolbasedmetrics-java">ProtocolBasedMetrics.java</h4>
<p>This class populates protocol-related metrics in the JSON tracking file. Multiple statistics can be processed through a single method since they often correlate:</p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">DistributionOfAttackProtocols</span><span> distributionOfAttackProtocols;
</span><span>
</span><span style="color:#b48ead;">public enum </span><span style="color:#ebcb8b;">ProtocolBasedType </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#d08770;">SSH</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">    </span><span style="color:#d08770;">UNKNOWN
</span><span style="color:#eff1f5;">}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#bf616a;">ProtocolBasedMetrics</span><span>() {
</span><span>    distributionOfAttackProtocols = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">DistributionOfAttackProtocols</span><span>();
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">DistributionOfAttackProtocols </span><span style="color:#bf616a;">getDistributionOfAttackProtocols</span><span>() {
</span><span>    </span><span style="color:#b48ead;">return</span><span> distributionOfAttackProtocols;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">populate</span><span>(</span><span style="color:#ebcb8b;">String</span><span> name, </span><span style="color:#b48ead;">int</span><span> amount) {
</span><span>    </span><span style="color:#bf616a;">getDistributionOfAttackProtocols</span><span>().</span><span style="color:#bf616a;">insert</span><span>(name, amount);
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">populate</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type, </span><span style="color:#b48ead;">int</span><span> amount) {
</span><span>    </span><span style="color:#bf616a;">getDistributionOfAttackProtocols</span><span>().</span><span style="color:#bf616a;">insert</span><span>(type, amount);
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">populate</span><span>(</span><span style="color:#ebcb8b;">String</span><span> type) {
</span><span>    </span><span style="color:#bf616a;">getDistributionOfAttackProtocols</span><span>().</span><span style="color:#bf616a;">insert</span><span>(type, </span><span style="color:#d08770;">1</span><span>);
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">populate</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type) {
</span><span>    </span><span style="color:#bf616a;">getDistributionOfAttackProtocols</span><span>().</span><span style="color:#bf616a;">insert</span><span>(type, </span><span style="color:#d08770;">1</span><span>);
</span><span>}
</span></code></pre>
<h4 id="distributionofattackprotocols-java">DistributionOfAttackProtocols.java</h4>
<p>This class represents a specific tracked statistic using a simple HashMap structure that is processed by the JSON Object Mapper:</p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">HashMap</span><span>&lt;</span><span style="color:#ebcb8b;">String</span><span>, </span><span style="color:#ebcb8b;">Integer</span><span>&gt; protocols = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">HashMap</span><span>&lt;&gt;();
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#bf616a;">DistributionOfAttackProtocols</span><span>() {}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">insert</span><span>(</span><span style="color:#ebcb8b;">String</span><span> type, </span><span style="color:#b48ead;">int</span><span> amount) {
</span><span>    </span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> protocolType = </span><span style="color:#bf616a;">getProtocolByName</span><span>(type);
</span><span>    </span><span style="color:#bf616a;">addAttempts</span><span>(protocolType, amount);
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public</span><span> void </span><span style="color:#bf616a;">insert</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type, </span><span style="color:#b48ead;">int</span><span> amount) {
</span><span>    </span><span style="color:#bf616a;">addAttempts</span><span>(type, amount);
</span><span>}
</span><span>
</span><span style="color:#b48ead;">private</span><span> void </span><span style="color:#bf616a;">addAttempts</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type, </span><span style="color:#b48ead;">int</span><span> amount) {
</span><span>    </span><span style="color:#ebcb8b;">String</span><span> protocolName = </span><span style="color:#bf616a;">getNameOfProtocol</span><span>(type);
</span><span>
</span><span>    </span><span style="color:#b48ead;">if </span><span>(protocols.</span><span style="color:#bf616a;">get</span><span>(protocolName) == </span><span style="color:#d08770;">null</span><span>) {
</span><span>        protocols.</span><span style="color:#bf616a;">put</span><span>(protocolName, amount);
</span><span>    } </span><span style="color:#b48ead;">else </span><span>{
</span><span>        protocols.</span><span style="color:#bf616a;">put</span><span>(protocolName, </span><span style="color:#bf616a;">getAttempts</span><span>(type) + amount);
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Integer </span><span style="color:#bf616a;">getAttempts</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type) {
</span><span>    </span><span style="color:#b48ead;">return</span><span> protocols.</span><span style="color:#bf616a;">get</span><span>(</span><span style="color:#bf616a;">getNameOfProtocol</span><span>(type));
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">ProtocolBasedType </span><span style="color:#bf616a;">getProtocolByName</span><span>(</span><span style="color:#ebcb8b;">String</span><span> protocol) {
</span><span>    </span><span style="color:#b48ead;">if </span><span>(protocol.</span><span style="color:#bf616a;">equalsIgnoreCase</span><span>(&quot;</span><span style="color:#a3be8c;">sshd</span><span>&quot;) || protocol.</span><span style="color:#bf616a;">equalsIgnoreCase</span><span>(&quot;</span><span style="color:#a3be8c;">ssh</span><span>&quot;)) {
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">ProtocolBasedType</span><span>.</span><span style="color:#d08770;">SSH</span><span>;
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">ProtocolBasedType</span><span>.</span><span style="color:#d08770;">UNKNOWN</span><span>;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">getNameOfProtocol</span><span>(</span><span style="color:#ebcb8b;">ProtocolBasedType</span><span> type) {
</span><span>    </span><span style="color:#b48ead;">return</span><span> type.</span><span style="color:#bf616a;">name</span><span>();
</span><span>}
</span></code></pre>
<h4 id="brutemetricdata-java">BruteMetricData.java</h4>
<p>This core class instantiates and manages all analytics and metrics components:</p>
<pre data-lang="java" style="background-color:#2b303b;color:#c0c5ce;" class="language-java "><code class="language-java" data-lang="java"><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">TimeBasedMetrics</span><span> timeBasedMetrics;
</span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">GeographicMetrics</span><span> geographicMetrics;
</span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">ProtocolBasedMetrics</span><span> protocolBasedMetrics;
</span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">CredentialBasedMetrics</span><span> credentialBasedMetrics;
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#bf616a;">BruteMetricData</span><span>() {
</span><span>    timeBasedMetrics = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">TimeBasedMetrics</span><span>();
</span><span>    geographicMetrics = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">GeographicMetrics</span><span>();
</span><span>    protocolBasedMetrics = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ProtocolBasedMetrics</span><span>();
</span><span>    credentialBasedMetrics = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CredentialBasedMetrics</span><span>();
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">TimeBasedMetrics </span><span style="color:#bf616a;">getTimeBasedMetrics</span><span>() {
</span><span>    </span><span style="color:#b48ead;">return</span><span> timeBasedMetrics;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">GeographicMetrics </span><span style="color:#bf616a;">getGeographicMetrics</span><span>() {
</span><span>    </span><span style="color:#b48ead;">return</span><span> geographicMetrics;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">ProtocolBasedMetrics </span><span style="color:#bf616a;">getProtocolBasedMetrics</span><span>() {
</span><span>    </span><span style="color:#b48ead;">return</span><span> protocolBasedMetrics;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">CredentialBasedMetrics </span><span style="color:#bf616a;">getCredentialBasedMetrics</span><span>() {
</span><span>    </span><span style="color:#b48ead;">return</span><span> credentialBasedMetrics;
</span><span>}
</span></code></pre>
<h2 id="openssh-integration">OpenSSH Integration</h2>
<h3 id="modifying-openssh">Modifying OpenSSH</h3>
<p>Standard OpenSSH includes a security mechanism that prevents credential leaking by overwriting incorrect password entries with <code>^M^?INCORRECT^@</code>. To capture these credentials, you must disable this protection by removing the following line from OpenSSH's source code:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>https://github.com/openssh/openssh-portable/blob/df56a8035d429b2184ee94aaa7e580c1ff67f73a/auth-pam.c#L1198
</span></code></pre>
<p><strong>Note:</strong> This modification intentionally introduces a security vulnerability to enable monitoring functionality.</p>
<h3 id="credential-dumping">Credential Dumping</h3>
<p>The application captures login credentials through a simple PAM module that writes to a text file:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#include </span><span>&quot;</span><span style="color:#a3be8c;">library.h</span><span>&quot;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">security/pam_appl.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">security/pam_modules.h</span><span>&gt;
</span><span>
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdio.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">string.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">unistd.h</span><span>&gt;
</span><span>
</span><span style="color:#b48ead;">#define </span><span>BE_LOG_FILE &quot;</span><span style="color:#a3be8c;">/var/log/brute_tracker.txt</span><span>&quot;
</span><span style="color:#b48ead;">#define </span><span>BE_DELAY </span><span style="color:#d08770;">700
</span><span>
</span><span>PAM_EXTERN </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">pam_sm_authenticate</span><span>(pam_handle_t *</span><span style="color:#bf616a;">pamh</span><span>, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">flags</span><span>, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span>, </span><span style="color:#b48ead;">const char </span><span>**</span><span style="color:#bf616a;">argv</span><span>) {
</span><span>    </span><span style="color:#b48ead;">char    </span><span>*username,
</span><span>            *password,
</span><span>            *protocol,
</span><span>            *hostname;
</span><span>
</span><span>    </span><span style="color:#bf616a;">pam_get_item</span><span>(pamh, PAM_USER, (</span><span style="color:#b48ead;">void</span><span>*)&amp;username);
</span><span>    </span><span style="color:#bf616a;">pam_get_item</span><span>(pamh, PAM_AUTHTOK, (</span><span style="color:#b48ead;">void</span><span>*)&amp;password);
</span><span>    </span><span style="color:#bf616a;">pam_get_item</span><span>(pamh, PAM_RHOST, (</span><span style="color:#b48ead;">void</span><span>*)&amp;hostname);
</span><span>    </span><span style="color:#bf616a;">pam_get_item</span><span>(pamh, PAM_SERVICE, (</span><span style="color:#b48ead;">void</span><span>*)&amp;protocol);
</span><span>
</span><span>    </span><span style="color:#65737e;">// Added a delay to ensure that BruteExpose gets to read the entry.
</span><span>    </span><span style="color:#bf616a;">usleep</span><span>(BE_DELAY);
</span><span>
</span><span>    FILE *fd = </span><span style="color:#96b5b4;">fopen</span><span>(BE_LOG_FILE, &quot;</span><span style="color:#a3be8c;">a</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">if </span><span>(fd != </span><span style="color:#d08770;">NULL</span><span>) {
</span><span>        </span><span style="color:#96b5b4;">fprintf</span><span>(fd, &quot;</span><span style="color:#d08770;">%s %s %s %s </span><span style="color:#96b5b4;">\n</span><span>&quot;, username, password, hostname, protocol);
</span><span>        </span><span style="color:#96b5b4;">fclose</span><span>(fd);
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">return</span><span> PAM_SUCCESS;
</span><span>}
</span></code></pre>
<p>The Java application monitors <code>brute_tracker.txt</code> for changes, processing new entries as they appear.</p>
<h3 id="pam-module-integration">PAM Module Integration</h3>
<p>After compiling the PAM module:</p>
<ol>
<li>Copy the <code>.pam</code> file to <code>/lib/x86_64-linux-gnu/security/</code></li>
<li>Edit the PAM configuration with <code>sudo nano /etc/pam.d/common-auth</code></li>
<li>Add the following entry before the deny statement:</li>
</ol>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># here are the per-package modules (the &quot;Primary&quot; block)
</span><span>auth    [success=2 default=ignore]      pam_unix.so nullok
</span><span># enable Live Security Monitor
</span><span>auth    optional                        libbe_pam.so
</span><span># here&#39;s the fallback if no module succeeds
</span><span>auth    requisite                       pam_deny.so
</span></code></pre>
<p>This configuration ensures that if <code>pam_unix.so</code> authentication succeeds, the next two lines are skipped. Otherwise, our monitoring module captures the credentials before access is denied.</p>
<h2 id="lessons-learned">Lessons Learned</h2>
<h3 id="architecture-improvements">Architecture Improvements</h3>
<p>If I were to rebuild this project, I would make the following changes:</p>
<ol>
<li>
<p><strong>Simplify Analytics</strong>: Replace the modular analytics system with hardcoded solutions for better simplicity and performance. The current design, while flexible, introduces unnecessary complexity for this specific use case.</p>
</li>
<li>
<p><strong>Language Selection</strong>: Implement the entire solution in C rather than using Java. The multi-language approach creates maintenance challenges and introduces unnecessary complexity.</p>
</li>
<li>
<p><strong>IP Data Source</strong>: Use the IPInfo API instead of the mmdb database to eliminate the need for manual database updates and ensure more current geolocation data.</p>
</li>
<li>
<p><strong>Data Storage</strong>: Replace the JSON-based storage with SQLite. JSON becomes inefficient at scale, particularly for reading operations, whereas SQLite would provide better performance for both reading and writing operations.</p>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>While functional, this project serves primarily as a learning experience rather than a production-ready security tool. The intentional OpenSSH vulnerability makes it unsuitable for legitimate security applications, but the development process provided valuable insights into system-level programming, credential monitoring techniques, and data analytics.</p>
 </main>
  </body>
</html>
